name: Upload GAN Model to CDN
description: Uploads trained GAN model as .pt file to CDN with metadata.
inputs:
  - name: trained_model
    type: Model
    description: "Trained model from Train GAN Model Enhanced component"
  - name: gan_config
    type: String
    description: "GAN configuration from Preprocess For GAN component"
  - name: training_metrics
    type: String
    description: "Training metrics from Train GAN Model Enhanced component"
  - name: bearer_token
    type: string
    description: "Access token from IAMLoginService component"
  - name: domain
    type: String
    description: "Domain for upload"
  - name: get_cdn
    type: String
    description: "CDN endpoint"
  - name: model_name
    type: String
    description: "Name for the model file"
    default: "gan_model"
outputs:
  - name: model_cdn_url
    type: String
    description: "CDN URL for the uploaded model .pt file"
  - name: config_cdn_url
    type: String
    description: "CDN URL for the model configuration"
  - name: model_metadata
    type: String
    description: "Metadata about uploaded model"
implementation:
  container:
    image: python:3.8-slim
    command:
      - sh
      - -c
      - |
        if ! command -v curl &> /dev/null; then
            apt-get update > /dev/null && apt-get install -y curl > /dev/null
        fi
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import sys, os, subprocess, json, pickle, tempfile, time, argparse
        
        parser = argparse.ArgumentParser()
        parser.add_argument('--trained_model_path', type=str, required=True)
        parser.add_argument('--gan_config_path', type=str, required=True)
        parser.add_argument('--training_metrics_path', type=str, required=True)
        parser.add_argument('--bearer_token_path', type=str, required=True)
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        parser.add_argument('--model_name', type=str, required=True)
        parser.add_argument('--model_cdn_url_path', type=str, required=True)
        parser.add_argument('--config_cdn_url_path', type=str, required=True)
        parser.add_argument('--model_metadata_path', type=str, required=True)
        args = parser.parse_args()
        
        print('Starting GAN Model CDN Upload')
        
        # Load bearer token
        with open(args.bearer_token_path, 'r') as f:
            bearer_token = f.read().strip()
        
        upload_url = f"{args.domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"
        
        # Function to upload file to CDN
        def upload_file_to_cdn(file_path, filename):
            print(f'Uploading {filename}...')
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error",
                "--silent"
            ]
            
            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    text=True,
                    check=True
                )
                
                response_json = json.loads(process.stdout)
                relative_cdn_url = response_json.get("cdnUrl", "")
                
                if not relative_cdn_url:
                    print('Error: No CDN URL in response')
                    return None
                
                full_url = f"{args.get_cdn}{relative_cdn_url}"
                print(f'Upload successful: {full_url}')
                return full_url
                
            except subprocess.CalledProcessError as e:
                print(f'Curl error: {e.returncode}')
                print(f'Error output: {e.stderr}')
                return None
            except json.JSONDecodeError as e:
                print(f'JSON parse error: {e}')
                return None
        
        # Load model and configurations
        with open(args.trained_model_path, 'rb') as f:
            gan_model = pickle.load(f)
        
        with open(args.gan_config_path, 'r') as f:
            gan_config = json.load(f)
        
        with open(args.training_metrics_path, 'r') as f:
            training_metrics = json.load(f)
        
        # Create model metadata
        model_type = gan_config.get('model_type', 'dcgan')
        timestamp = time.strftime('%Y%m%d_%H%M%S')
        base_filename = f"{args.model_name}_{model_type}_{timestamp}"
        
        model_url = None
        config_url = None
        
        with tempfile.TemporaryDirectory() as temp_dir:
            # 1. Save model as .pt file
            model_file_path = os.path.join(temp_dir, f'{base_filename}.pt')
            
            # Extract model state dicts
            model_data = {
                'generator_state_dict': None,
                'discriminator_state_dict': None,
                'config': gan_config,
                'training_metrics': training_metrics,
                'model_type': model_type,
                'timestamp': timestamp
            }
            
            # Try to extract model state dicts
            try:
                if hasattr(gan_model, 'generator'):
                    model_data['generator_state_dict'] = gan_model.generator.state_dict()
                if hasattr(gan_model, 'discriminator'):
                    model_data['discriminator_state_dict'] = gan_model.discriminator.state_dict()
                if hasattr(gan_model, 'trainer'):
                    if hasattr(gan_model.trainer, 'generator'):
                        model_data['generator_state_dict'] = gan_model.trainer.generator.state_dict()
                    if hasattr(gan_model.trainer, 'discriminator'):
                        model_data['discriminator_state_dict'] = gan_model.trainer.discriminator.state_dict()
            except Exception as e:
                print(f'Warning: Could not extract model state dicts: {e}')
            
            # Save model as .pt file
            torch.save(model_data, model_file_path)
            print(f'Saved model to: {model_file_path}')
            
            # Upload model .pt file
            model_url = upload_file_to_cdn(model_file_path, f'{base_filename}.pt')
            
            # 2. Save configuration as JSON
            config_file_path = os.path.join(temp_dir, f'{base_filename}_config.json')
            with open(config_file_path, 'w') as f:
                json.dump({
                    'gan_config': gan_config,
                    'training_metrics': training_metrics,
                    'model_type': model_type,
                    'upload_timestamp': timestamp
                }, f, indent=2)
            
            # Upload configuration
            config_url = upload_file_to_cdn(config_file_path, f'{base_filename}_config.json')
        
        # Create model metadata
        model_metadata = {
            'model_name': args.model_name,
            'model_type': model_type,
            'timestamp': timestamp,
            'model_filename': f'{base_filename}.pt',
            'config_filename': f'{base_filename}_config.json',
            'model_url': model_url if model_url else '',
            'config_url': config_url if config_url else '',
            'upload_status': {
                'model_uploaded': model_url is not None,
                'config_uploaded': config_url is not None,
                'upload_time': time.strftime('%Y-%m-%d %H:%M:%S')
            },
            'model_info': {
                'has_generator': model_data['generator_state_dict'] is not None,
                'has_discriminator': model_data['discriminator_state_dict'] is not None,
                'training_epochs': training_metrics.get('total_epochs', 0),
                'final_metrics': training_metrics.get('final_metrics', {})
            }
        }
        
        # Save outputs
        os.makedirs(os.path.dirname(args.model_cdn_url_path) or '.', exist_ok=True)
        with open(args.model_cdn_url_path, 'w') as f:
            f.write(model_url if model_url else '')
        
        os.makedirs(os.path.dirname(args.config_cdn_url_path) or '.', exist_ok=True)
        with open(args.config_cdn_url_path, 'w') as f:
            f.write(config_url if config_url else '')
        
        os.makedirs(os.path.dirname(args.model_metadata_path) or '.', exist_ok=True)
        with open(args.model_metadata_path, 'w') as f:
            json.dump(model_metadata, f, indent=2)
        
        print('GAN Model CDN Upload Summary:')
        print(f'  Model uploaded: {'Yes' if model_url else 'No'}')
        print(f'  Config uploaded: {'Yes' if config_url else 'No'}')
        print(f'  Model metadata saved to: {args.model_metadata_path}')
    args:
      - --trained_model_path
      - {inputPath: trained_model}
      - --gan_config_path
      - {inputPath: gan_config}
      - --training_metrics_path
      - {inputPath: training_metrics}
      - --bearer_token_path
      - {inputPath: bearer_token}
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      - --model_name
      - {inputValue: model_name}
      - --model_cdn_url_path
      - {outputPath: model_cdn_url}
      - --config_cdn_url_path
      - {outputPath: config_cdn_url}
      - --model_metadata_path
      - {outputPath: model_metadata}
