name: Upload DCGAN Images To CDN
description: Uploads DCGAN generated images and evaluation results to CDN.
inputs:
  - name: generated_images
    type: Dataset
  - name: eval_metrics
    type: String
  - name: evaluation_report
    type: String
  - name: bearer_token
    type: string
  - name: domain
    type: String
  - name: get_cdn
    type: String
outputs:
  - name: images_cdn_urls
    type: String
    description: "JSON list of CDN URLs for generated images"
  - name: metrics_cdn_url
    type: String
    description: "CDN URL for evaluation metrics"
  - name: report_cdn_url
    type: String
    description: "CDN URL for evaluation report"
implementation:
  container:
    image: python:3.8-slim
    command:
      - sh
      - -ec
      - |
        if ! command -v curl &> /dev/null; then
            echo "curl not found, installing..."
            apt-get update > /dev/null && apt-get install -y curl > /dev/null
        fi
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import sys, os, subprocess, json, base64, pickle, uuid, tempfile
        from pathlib import Path
        
        print('Starting DCGAN Images CDN Upload')
        
        # Parse arguments
        generated_images_path = sys.argv[1]
        eval_metrics_path = sys.argv[2]
        evaluation_report_path = sys.argv[3]
        bearer_token_path = sys.argv[4]
        domain = sys.argv[5]
        get_cdn = sys.argv[6]
        images_urls_path = sys.argv[7]
        metrics_url_path = sys.argv[8]
        report_url_path = sys.argv[9]
        
        print('Loading inputs...')
        
        # Load bearer token
        with open(bearer_token_path, 'r') as f:
            bearer_token = f.read().strip()
        
        upload_url = f"{domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"
        
        # Function to upload file to CDN
        def upload_file_to_cdn(file_path, filename):
            print(f'Uploading {filename}...')
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error",
                "--silent"
            ]
            
            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    text=True,
                    check=True
                )
                
                response_json = json.loads(process.stdout)
                relative_cdn_url = response_json.get("cdnUrl", "")
                
                if not relative_cdn_url:
                    print('Error: No CDN URL in response')
                    return None
                
                full_url = f"{get_cdn}{relative_cdn_url}"
                print(f'Upload successful: {full_url}')
                return full_url
                
            except subprocess.CalledProcessError as e:
                print(f'Curl error: {e.returncode}')
                print(f'Error output: {e.stderr}')
                return None
            except json.JSONDecodeError as e:
                print(f'JSON parse error: {e}')
                return None
        
        # Load generated images
        with open(generated_images_path, 'rb') as f:
            generated_images = pickle.load(f)
        
        print(f'Loaded {len(generated_images)} generated images')
        
        # Upload each image to CDN
        image_urls = []
        
        with tempfile.TemporaryDirectory() as temp_dir:
            for i, img_data in enumerate(generated_images):
                try:
                    # Decode base64 image
                    img_bytes = base64.b64decode(img_data['image_data'])
                    
                    # Save to temporary file
                    temp_file = os.path.join(temp_dir, f'image_{i:03d}.png')
                    with open(temp_file, 'wb') as f:
                        f.write(img_bytes)
                    
                    # Upload to CDN
                    filename = img_data.get('filename', f'dcgan_image_{i:03d}.png')
                    cdn_url = upload_file_to_cdn(temp_file, filename)
                    
                    if cdn_url:
                        image_urls.append({
                            'index': i,
                            'filename': filename,
                            'cdn_url': cdn_url,
                            'brightness': img_data.get('brightness', 0),
                            'contrast': img_data.get('contrast', 0)
                        })
                        print(f'Uploaded image {i+1}/{len(generated_images)}')
                    else:
                        print(f'Failed to upload image {i+1}')
                        
                except Exception as e:
                    print(f'Error processing image {i}: {str(e)}')
                    continue
        
        # Upload evaluation metrics
        metrics_url = None
        if os.path.exists(eval_metrics_path):
            with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as temp_file:
                # Read and copy metrics
                with open(eval_metrics_path, 'r') as f:
                    metrics_content = f.read()
                temp_file.write(metrics_content)
                temp_file_path = temp_file.name
            
            metrics_url = upload_file_to_cdn(temp_file_path, 'dcgan_evaluation_metrics.json')
            os.unlink(temp_file_path)
        
        # Upload evaluation report
        report_url = None
        if os.path.exists(evaluation_report_path):
            with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as temp_file:
                # Read and copy report
                with open(evaluation_report_path, 'r') as f:
                    report_content = f.read()
                temp_file.write(report_content)
                temp_file_path = temp_file.name
            
            report_url = upload_file_to_cdn(temp_file_path, 'dcgan_evaluation_report.txt')
            os.unlink(temp_file_path)
        
        # Save outputs
        # Save image URLs
        output_dir = os.path.dirname(images_urls_path)
        if output_dir and not os.path.exists(output_dir):
            os.makedirs(output_dir, exist_ok=True)
        
        with open(images_urls_path, 'w') as f:
            json.dump(image_urls, f, indent=2)
        
        # Save metrics URL
        output_dir_metrics = os.path.dirname(metrics_url_path)
        if output_dir_metrics and not os.path.exists(output_dir_metrics):
            os.makedirs(output_dir_metrics, exist_ok=True)
        
        with open(metrics_url_path, 'w') as f:
            f.write(metrics_url if metrics_url else '')
        
        # Save report URL
        output_dir_report = os.path.dirname(report_url_path)
        if output_dir_report and not os.path.exists(output_dir_report):
            os.makedirs(output_dir_report, exist_ok=True)
        
        with open(report_url_path, 'w') as f:
            f.write(report_url if report_url else '')
        
        print('\\nUpload Summary:')
        print(f'  Images uploaded: {len(image_urls)}/{len(generated_images)}')
        print(f'  Metrics uploaded: {'Yes' if metrics_url else 'No'}')
        print(f'  Report uploaded: {'Yes' if report_url else 'No'}')
        print('DCGAN CDN Upload Complete')
        " "$0" "$1" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9"
    args:
      - {inputPath: generated_images}
      - {inputPath: eval_metrics}
      - {inputPath: evaluation_report}
      - {inputPath: bearer_token}
      - {inputValue: domain}
      - {inputValue: get_cdn}
      - {outputPath: images_cdn_urls}
      - {outputPath: metrics_cdn_url}
      - {outputPath: report_cdn_url}
