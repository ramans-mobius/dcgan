name: Upload GAN Images To CDN
description: Uploads GAN generated images and results to CDN.
inputs:
  - name: cdn_ready_images
    type: Dataset
    description: "Images from Visualize GAN Results component"
  - name: training_metrics
    type: String
    description: "Training metrics from Train GAN Model component"
  - name: visualization_report
    type: String
    description: "Visualization report from Visualize GAN Results component"
  - name: bearer_token
    type: string
    description: "Access token from IAMLoginService component"
  - name: domain
    type: String
    description: "Domain for upload"
  - name: get_cdn
    type: String
    description: "CDN endpoint"
outputs:
  - name: images_cdn_urls
    type: String
    description: "JSON list of CDN URLs for generated images"
  - name: metrics_cdn_url
    type: String
    description: "CDN URL for evaluation metrics"
  - name: report_cdn_url
    type: String
    description: "CDN URL for evaluation report"
  - name: upload_summary
    type: String
    description: "Summary of upload results"
implementation:
  container:
    image: python:3.8-slim
    command:
      - sh
      - -c
      - |
        if ! command -v curl &> /dev/null; then
            echo "curl not found, installing..."
            apt-get update > /dev/null && apt-get install -y curl > /dev/null
        fi
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import sys, os, subprocess, json, base64, pickle, uuid, tempfile
        from pathlib import Path
        
        print('Starting GAN Images CDN Upload')
        
        # Parse arguments
        cdn_ready_images_path = sys.argv[1]
        training_metrics_path = sys.argv[2]
        visualization_report_path = sys.argv[3]
        bearer_token_path = sys.argv[4]
        domain = sys.argv[5]
        get_cdn = sys.argv[6]
        images_urls_path = sys.argv[7]
        metrics_url_path = sys.argv[8]
        report_url_path = sys.argv[9]
        upload_summary_path = sys.argv[10]
        
        print('Loading inputs...')
        
        # Load bearer token
        with open(bearer_token_path, 'r') as f:
            bearer_token = f.read().strip()
        
        upload_url = f"{domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"
        
        # Function to upload file to CDN
        def upload_file_to_cdn(file_path, filename):
            print(f'Uploading {filename}...')
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error",
                "--silent"
            ]
            
            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    text=True,
                    check=True
                )
                
                response_json = json.loads(process.stdout)
                relative_cdn_url = response_json.get("cdnUrl", "")
                
                if not relative_cdn_url:
                    print('Error: No CDN URL in response')
                    return None
                
                full_url = f"{get_cdn}{relative_cdn_url}"
                print(f'Upload successful: {full_url}')
                return full_url
                
            except subprocess.CalledProcessError as e:
                print(f'Curl error: {e.returncode}')
                print(f'Error output: {e.stderr}')
                return None
            except json.JSONDecodeError as e:
                print(f'JSON parse error: {e}')
                return None
        
        # Load CDN-ready images
        with open(cdn_ready_images_path, 'rb') as f:
            cdn_ready_images = pickle.load(f)
        
        print(f'Loaded {len(cdn_ready_images)} CDN-ready images')
        
        # Upload each image to CDN
        image_urls = []
        uploaded_count = 0
        
        with tempfile.TemporaryDirectory() as temp_dir:
            for i, img_data in enumerate(cdn_ready_images):
                try:
                    # Decode base64 image
                    img_bytes = base64.b64decode(img_data['image_data'])
                    
                    # Save to temporary file
                    temp_file = os.path.join(temp_dir, f'image_{i:03d}.png')
                    with open(temp_file, 'wb') as f:
                        f.write(img_bytes)
                    
                    # Upload to CDN
                    filename = img_data.get('filename', f'gan_image_{i:03d}.png')
                    cdn_url = upload_file_to_cdn(temp_file, filename)
                    
                    if cdn_url:
                        image_urls.append({
                            'index': i,
                            'filename': filename,
                            'cdn_url': cdn_url,
                            'metadata': img_data.get('metadata', {})
                        })
                        uploaded_count += 1
                        print(f'Uploaded image {i+1}/{len(cdn_ready_images)}')
                    else:
                        print(f'Failed to upload image {i+1}')
                        
                except Exception as e:
                    print(f'Error processing image {i}: {str(e)}')
                    continue
        
        # Upload training metrics
        metrics_url = None
        if os.path.exists(training_metrics_path):
            with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as temp_file:
                with open(training_metrics_path, 'r') as f:
                    metrics_content = f.read()
                temp_file.write(metrics_content)
                temp_file_path = temp_file.name
            
            metrics_url = upload_file_to_cdn(temp_file_path, 'gan_training_metrics.json')
            os.unlink(temp_file_path)
        
        # Upload visualization report
        report_url = None
        if os.path.exists(visualization_report_path):
            with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as temp_file:
                with open(visualization_report_path, 'r') as f:
                    report_content = f.read()
                temp_file.write(report_content)
                temp_file_path = temp_file.name
            
            report_url = upload_file_to_cdn(temp_file_path, 'gan_visualization_report.json')
            os.unlink(temp_file_path)
        
        # Create upload summary
        upload_summary = {
            'total_images_uploaded': uploaded_count,
            'total_images_attempted': len(cdn_ready_images),
            'success_rate': (uploaded_count / len(cdn_ready_images)) * 100 if cdn_ready_images else 0,
            'metrics_uploaded': metrics_url is not None,
            'report_uploaded': report_url is not None,
            'image_urls_count': len(image_urls),
            'upload_timestamp': time.strftime('%Y-%m-%d %H:%M:%S')
        }
        
        # Save outputs
        output_dir = os.path.dirname(images_urls_path)
        if output_dir and not os.path.exists(output_dir):
            os.makedirs(output_dir, exist_ok=True)
        
        with open(images_urls_path, 'w') as f:
            json.dump(image_urls, f, indent=2)
        
        output_dir_metrics = os.path.dirname(metrics_url_path)
        if output_dir_metrics and not os.path.exists(output_dir_metrics):
            os.makedirs(output_dir_metrics, exist_ok=True)
        
        with open(metrics_url_path, 'w') as f:
            f.write(metrics_url if metrics_url else '')
        
        output_dir_report = os.path.dirname(report_url_path)
        if output_dir_report and not os.path.exists(output_dir_report):
            os.makedirs(output_dir_report, exist_ok=True)
        
        with open(report_url_path, 'w') as f:
            f.write(report_url if report_url else '')
        
        output_dir_summary = os.path.dirname(upload_summary_path)
        if output_dir_summary and not os.path.exists(output_dir_summary):
            os.makedirs(output_dir_summary, exist_ok=True)
        
        with open(upload_summary_path, 'w') as f:
            json.dump(upload_summary, f, indent=2)
        
        print('Upload Summary:')
        print(f'  Images uploaded: {uploaded_count}/{len(cdn_ready_images)}')
        print(f'  Metrics uploaded: {'Yes' if metrics_url else 'No'}')
        print(f'  Report uploaded: {'Yes' if report_url else 'No'}')
        print('GAN CDN Upload Complete')
    args:
      - --cdn_ready_images_path
      - {inputPath: cdn_ready_images}
      - --training_metrics_path
      - {inputPath: training_metrics}
      - --visualization_report_path
      - {inputPath: visualization_report}
      - --bearer_token_path
      - {inputPath: bearer_token}
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      - --images_urls_path
      - {outputPath: images_cdn_urls}
      - --metrics_url_path
      - {outputPath: metrics_cdn_url}
      - --report_url_path
      - {outputPath: report_cdn_url}
      - --upload_summary_path
      - {outputPath: upload_summary}
