name: 2 Upload GAN Results To CDN
description: Uploads GAN generated images and training results directly to CDN.
inputs:
  - name: generated_samples
    type: Dataset
    description: "Generated samples from Train GAN Model Enhanced component"
  - name: training_metrics
    type: String
    description: "Training metrics from Train GAN Model Enhanced component"
  - name: training_history
    type: String
    description: "Training history from Train GAN Model Enhanced component"
  - name: gan_config
    type: String
    description: "GAN configuration from Preprocess For GAN component"
  - name: bearer_token
    type: string
    description: "Access token from IAMLoginService component"
  - name: domain
    type: String
    description: "Domain for upload"
  - name: get_cdn
    type: String
    description: "CDN endpoint"
outputs:
  - name: images_cdn_urls
    type: String
    description: "JSON list of CDN URLs for generated images"
  - name: metrics_cdn_url
    type: String
    description: "CDN URL for training metrics"
  - name: history_cdn_url
    type: String
    description: "CDN URL for training history"
  - name: upload_summary
    type: String
    description: "Summary of upload results"
implementation:
  container:
    image: python:3.8-slim
    command:
      - sh
      - -c
      - |
        if ! command -v curl &> /dev/null; then
            apt-get update > /dev/null && apt-get install -y curl > /dev/null
        fi
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import sys, os, subprocess, json, base64, pickle, time, tempfile
        
        print('Starting GAN Results CDN Upload')
        
        # Parse arguments
        generated_samples_path = sys.argv[1]
        training_metrics_path = sys.argv[2]
        training_history_path = sys.argv[3]
        gan_config_path = sys.argv[4]
        bearer_token_path = sys.argv[5]
        domain = sys.argv[6]
        get_cdn = sys.argv[7]
        images_urls_path = sys.argv[8]
        metrics_url_path = sys.argv[9]
        history_url_path = sys.argv[10]
        upload_summary_path = sys.argv[11]
        
        print('Loading inputs...')
        
        # Load bearer token
        with open(bearer_token_path, 'r') as f:
            bearer_token = f.read().strip()
        
        upload_url = f"{domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"
        
        # Function to upload file to CDN
        def upload_file_to_cdn(file_path, filename):
            print(f'Uploading {filename}...')
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error",
                "--silent"
            ]
            
            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    text=True,
                    check=True
                )
                
                response_json = json.loads(process.stdout)
                relative_cdn_url = response_json.get("cdnUrl", "")
                
                if not relative_cdn_url:
                    print('Error: No CDN URL in response')
                    return None
                
                full_url = f"{get_cdn}{relative_cdn_url}"
                print(f'Upload successful: {full_url}')
                return full_url
                
            except subprocess.CalledProcessError as e:
                print(f'Curl error: {e.returncode}')
                print(f'Error output: {e.stderr}')
                return None
            except json.JSONDecodeError as e:
                print(f'JSON parse error: {e}')
                return None
        
        # Load generated samples
        with open(generated_samples_path, 'rb') as f:
            generated_samples = pickle.load(f)
        
        print(f'Loaded {len(generated_samples)} generated samples')
        
        # Load configurations for metadata
        with open(gan_config_path, 'r') as f:
            gan_config = json.load(f)
        
        model_type = gan_config.get('model_type', 'dcgan')
        timestamp = time.strftime('%Y%m%d_%H%M%S')
        
        # Upload each generated image to CDN
        image_urls = []
        uploaded_count = 0
        
        with tempfile.TemporaryDirectory() as temp_dir:
            for i, sample in enumerate(generated_samples):
                try:
                    # Decode base64 image
                    img_data = base64.b64decode(sample['image_data'])
                    
                    # Save to temporary file
                    temp_file = os.path.join(temp_dir, f'image_{i:03d}.png')
                    with open(temp_file, 'wb') as f:
                        f.write(img_data)
                    
                    # Use filename from sample or generate one
                    filename = sample.get('filename', f'{model_type}_sample_{i:03d}.png')
                    cdn_url = upload_file_to_cdn(temp_file, filename)
                    
                    if cdn_url:
                        image_urls.append({
                            'index': i,
                            'filename': filename,
                            'cdn_url': cdn_url,
                            'metadata': {
                                'epoch': sample.get('epoch', 'unknown'),
                                'model_type': model_type,
                                'sample_index': i
                            }
                        })
                        uploaded_count += 1
                        print(f'Uploaded image {i+1}/{len(generated_samples)}')
                    else:
                        print(f'Failed to upload image {i+1}')
                        
                except Exception as e:
                    print(f'Error processing image {i}: {str(e)}')
                    continue
        
        # Upload training metrics
        metrics_url = None
        if os.path.exists(training_metrics_path):
            metrics_filename = f'{model_type}_training_metrics_{timestamp}.json'
            with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as temp_file:
                with open(training_metrics_path, 'r') as f:
                    metrics_content = f.read()
                temp_file.write(metrics_content)
                temp_file_path = temp_file.name
            
            metrics_url = upload_file_to_cdn(temp_file_path, metrics_filename)
            os.unlink(temp_file_path)
        
        # Upload training history
        history_url = None
        if os.path.exists(training_history_path):
            history_filename = f'{model_type}_training_history_{timestamp}.json'
            with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as temp_file:
                with open(training_history_path, 'r') as f:
                    history_content = f.read()
                temp_file.write(history_content)
                temp_file_path = temp_file.name
            
            history_url = upload_file_to_cdn(temp_file_path, history_filename)
            os.unlink(temp_file_path)
        
        # Create upload summary
        upload_summary = {
            'model_type': model_type,
            'timestamp': timestamp,
            'images': {
                'uploaded': uploaded_count,
                'total': len(generated_samples),
                'success_rate': (uploaded_count / len(generated_samples)) * 100 if generated_samples else 0
            },
            'files_uploaded': {
                'metrics': metrics_url is not None,
                'history': history_url is not None
            },
            'urls': {
                'images_count': len(image_urls),
                'metrics_url': metrics_url if metrics_url else '',
                'history_url': history_url if history_url else ''
            },
            'upload_time': time.strftime('%Y-%m-%d %H:%M:%S')
        }
        
        # Save outputs
        os.makedirs(os.path.dirname(images_urls_path) or '.', exist_ok=True)
        with open(images_urls_path, 'w') as f:
            json.dump(image_urls, f, indent=2)
        
        os.makedirs(os.path.dirname(metrics_url_path) or '.', exist_ok=True)
        with open(metrics_url_path, 'w') as f:
            f.write(metrics_url if metrics_url else '')
        
        os.makedirs(os.path.dirname(history_url_path) or '.', exist_ok=True)
        with open(history_url_path, 'w') as f:
            f.write(history_url if history_url else '')
        
        os.makedirs(os.path.dirname(upload_summary_path) or '.', exist_ok=True)
        with open(upload_summary_path, 'w') as f:
            json.dump(upload_summary, f, indent=2)
        
        print('GAN Results CDN Upload Summary:')
        print(f'  Model Type: {model_type}')
        print(f'  Images uploaded: {uploaded_count}/{len(generated_samples)}')
        print(f'  Metrics uploaded: {'Yes' if metrics_url else 'No'}')
        print(f'  History uploaded: {'Yes' if history_url else 'No'}')
        print('GAN CDN Upload Complete')
    args:
      - --generated_samples_path
      - {inputPath: generated_samples}
      - --training_metrics_path
      - {inputPath: training_metrics}
      - --training_history_path
      - {inputPath: training_history}
      - --gan_config_path
      - {inputPath: gan_config}
      - --bearer_token_path
      - {inputPath: bearer_token}
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      - --images_urls_path
      - {outputPath: images_cdn_urls}
      - --metrics_url_path
      - {outputPath: metrics_cdn_url}
      - --history_url_path
      - {outputPath: history_cdn_url}
      - --upload_summary_path
      - {outputPath: upload_summary}
